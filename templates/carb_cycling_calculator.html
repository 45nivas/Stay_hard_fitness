{% extends 'base.html' %}
{% load static %}

{% block title %}Carb Cycling Calculator{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1>Carb Cycling Calculator</h1>
        <p class="text-secondary">Advanced nutrition strategy for optimized body composition</p>
    </div>

    <!-- Beginner Alert Banner -->
    <div class="alert alert-warning mb-4">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div>
            <strong>Beginner Alert:</strong> Carb cycling is generally for advanced lifters. Beginners may experience dizziness or fatigue; consult a professional before starting.
        </div>
    </div>

    <div class="calculator-container">
        <!-- Input Form -->
        <div class="form-container">
            <h2 class="form-title">Personal Information</h2>
            
            <form id="carbCyclingForm" class="calculator-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="age" class="form-label">Age</label>
                        <input type="number" id="age" class="form-input" placeholder="25" min="16" max="80" required>
                    </div>
                    <div class="form-group">
                        <label for="gender" class="form-label">Gender</label>
                        <select id="gender" class="form-input" required>
                            <option value="">Select gender</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="weight" class="form-label">Weight (lbs)</label>
                        <input type="number" id="weight" class="form-input" placeholder="170" min="80" max="400" required>
                    </div>
                    <div class="form-group">
                        <label for="height" class="form-label">Height (inches)</label>
                        <input type="number" id="height" class="form-input" placeholder="68" min="48" max="84" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="goal" class="form-label">Primary Goal</label>
                    <select id="goal" class="form-input" required>
                        <option value="">Select your goal</option>
                        <option value="fat_loss">Fat Loss</option>
                        <option value="muscle_gain">Muscle Gain</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="recomposition">Body Recomposition</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="activityLevel" class="form-label">Activity Level</label>
                    <select id="activityLevel" class="form-input" required>
                        <option value="">Select activity level</option>
                        <option value="sedentary">Sedentary (desk job, minimal exercise)</option>
                        <option value="lightly_active">Lightly Active (light exercise 1-3 days/week)</option>
                        <option value="moderately_active">Moderately Active (moderate exercise 3-5 days/week)</option>
                        <option value="very_active">Very Active (hard exercise 6-7 days/week)</option>
                        <option value="extremely_active">Extremely Active (physical job + exercise)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="trainingDays" class="form-label">Training Days Per Week</label>
                    <select id="trainingDays" class="form-input" required>
                        <option value="">Select training frequency</option>
                        <option value="3">3 days/week</option>
                        <option value="4">4 days/week</option>
                        <option value="5">5 days/week</option>
                        <option value="6">6 days/week</option>
                        <option value="7">7 days/week</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">Calculate Carb Cycling Plan</button>
            </form>
        </div>

        <!-- Results Container -->
        <div id="results" class="results-container" style="display: none;">
            <h2 class="results-title">Your Carb Cycling Plan</h2>
            
            <!-- Daily Macros -->
            <div class="macro-cards">
                <div class="macro-card high-carb">
                    <div class="macro-header">
                        <h3>High-Carb Days</h3>
                        <span class="day-type">Training Days</span>
                    </div>
                    <div class="macro-stats">
                        <div class="macro-stat">
                            <span class="macro-value" id="highCalories">0</span>
                            <span class="macro-label">Calories</span>
                        </div>
                        <div class="macro-stat">
                            <span class="macro-value" id="highCarbs">0g</span>
                            <span class="macro-label">Carbs</span>
                        </div>
                        <div class="macro-stat">
                            <span class="macro-value" id="highProtein">0g</span>
                            <span class="macro-label">Protein</span>
                        </div>
                        <div class="macro-stat">
                            <span class="macro-value" id="highFat">0g</span>
                            <span class="macro-label">Fat</span>
                        </div>
                    </div>
                </div>

                <div class="macro-card medium-carb">
                    <div class="macro-header">
                        <h3>Medium-Carb Days</h3>
                        <span class="day-type">Light Training</span>
                    </div>
                    <div class="macro-stats">
                        <div class="macro-stat">
                            <span class="macro-value" id="mediumCalories">0</span>
                            <span class="macro-label">Calories</span>
                        </div>
                        <div class="macro-stat">
                            <span class="macro-value" id="mediumCarbs">0g</span>
                            <span class="macro-label">Carbs</span>
                        </div>
                        <div class="macro-stat">
                            <span class="macro-value" id="mediumProtein">0g</span>
                            <span class="macro-label">Protein</span>
                        </div>
                        <div class="macro-stat">
                            <span class="macro-value" id="mediumFat">0g</span>
                            <span class="macro-label">Fat</span>
                        </div>
                    </div>
                </div>

                <div class="macro-card low-carb">
                    <div class="macro-header">
                        <h3>Low-Carb Days</h3>
                        <span class="day-type">Rest Days</span>
                    </div>
                    <div class="macro-stats">
                        <div class="macro-stat">
                            <span class="macro-value" id="lowCalories">0</span>
                            <span class="macro-label">Calories</span>
                        </div>
                        <div class="macro-stat">
                            <span class="macro-value" id="lowCarbs">0g</span>
                            <span class="macro-label">Carbs</span>
                        </div>
                        <div class="macro-stat">
                            <span class="macro-value" id="lowProtein">0g</span>
                            <span class="macro-label">Protein</span>
                        </div>
                        <div class="macro-stat">
                            <span class="macro-value" id="lowFat">0g</span>
                            <span class="macro-label">Fat</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weekly Schedule -->
            <div class="schedule-container">
                <h3 class="schedule-title">Weekly Schedule</h3>
                <div class="schedule-grid" id="weeklySchedule">
                    <!-- Generated by JavaScript -->
                </div>
                <div class="schedule-note">
                    <div class="note-icon">üí°</div>
                    <p><strong>Pro Tip:</strong> Match high-carb days to your most intense training sessions, and low-carb days to rest days for optimal fat burning and recovery.</p>
                </div>
            </div>

            <!-- Implementation Tips -->
            <div class="tips-container">
                <h3 class="tips-title">Implementation Guidelines</h3>
                <div class="tips-grid">
                    <div class="tip-card">
                        <div class="tip-icon">üïê</div>
                        <h4>Timing</h4>
                        <p>Eat most carbs around your workouts for maximum performance and recovery.</p>
                    </div>
                    <div class="tip-card">
                        <div class="tip-icon">üíß</div>
                        <h4>Hydration</h4>
                        <p>Increase water intake on high-carb days as carbs require more water for storage.</p>
                    </div>
                    <div class="tip-card">
                        <div class="tip-icon">üìä</div>
                        <h4>Tracking</h4>
                        <p>Monitor energy levels, performance, and body composition weekly for adjustments.</p>
                    </div>
                    <div class="tip-card">
                        <div class="tip-icon">üîÑ</div>
                        <h4>Flexibility</h4>
                        <p>Adjust carb amounts based on training intensity and individual response.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('carbCyclingForm');
    const results = document.getElementById('results');

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        calculateCarbCycling();
    });

    function calculateCarbCycling() {
        // Get form values
        const age = parseInt(document.getElementById('age').value);
        const gender = document.getElementById('gender').value;
        const weight = parseFloat(document.getElementById('weight').value);
        const height = parseInt(document.getElementById('height').value);
        const goal = document.getElementById('goal').value;
        const activityLevel = document.getElementById('activityLevel').value;
        const trainingDays = parseInt(document.getElementById('trainingDays').value);

        // Validate inputs
        if (!age || !gender || !weight || !height || !goal || !activityLevel || !trainingDays) {
            alert('Please fill in all fields');
            return;
        }

        // Calculate BMR using Mifflin-St Jeor equation
        let bmr;
        if (gender === 'male') {
            bmr = (10 * weight * 0.453592) + (6.25 * height * 2.54) - (5 * age) + 5;
        } else {
            bmr = (10 * weight * 0.453592) + (6.25 * height * 2.54) - (5 * age) - 161;
        }

        // Calculate TDEE based on activity level
        const activityMultipliers = {
            'sedentary': 1.2,
            'lightly_active': 1.375,
            'moderately_active': 1.55,
            'very_active': 1.725,
            'extremely_active': 1.9
        };

        let tdee = bmr * activityMultipliers[activityLevel];

        // Adjust TDEE based on goal
        const goalAdjustments = {
            'fat_loss': -0.15,        // 15% deficit
            'muscle_gain': 0.10,      // 10% surplus
            'maintenance': 0,         // No change
            'recomposition': -0.05    // Small deficit
        };

        tdee *= (1 + goalAdjustments[goal]);

        // Calculate protein (constant across all days)
        let protein;
        if (goal === 'muscle_gain') {
            protein = weight * 1.2; // 1.2g per lb for muscle gain
        } else if (goal === 'fat_loss') {
            protein = weight * 1.1; // 1.1g per lb for fat loss
        } else {
            protein = weight * 1.0; // 1g per lb for maintenance
        }

        // Calculate carb amounts based on Trainer Josh's approach
        const carbsPerPound = {
            low: 0.25,      // Low-carb days: 0.25g per lb
            medium: 0.75,   // Medium-carb days: 0.75g per lb
            high: 1.5       // High-carb days: 1.5g per lb
        };

        // Adjust for goal
        if (goal === 'fat_loss') {
            carbsPerPound.low *= 0.8;
            carbsPerPound.medium *= 0.9;
            carbsPerPound.high *= 0.95;
        } else if (goal === 'muscle_gain') {
            carbsPerPound.low *= 1.2;
            carbsPerPound.medium *= 1.1;
            carbsPerPound.high *= 1.1;
        }

        const lowCarbs = Math.round(weight * carbsPerPound.low);
        const mediumCarbs = Math.round(weight * carbsPerPound.medium);
        const highCarbs = Math.round(weight * carbsPerPound.high);

        // Calculate fat to fill remaining calories
        const proteinCalories = protein * 4;
        
        const lowCarbCalories = lowCarbs * 4;
        const mediumCarbCalories = mediumCarbs * 4;
        const highCarbCalories = highCarbs * 4;

        // Adjust daily calories based on carb day type
        const lowDayCalories = Math.round(tdee * 0.85);  // Lower calories on low-carb days
        const mediumDayCalories = Math.round(tdee);       // Base calories on medium days
        const highDayCalories = Math.round(tdee * 1.15); // Higher calories on high-carb days

        const lowFat = Math.round((lowDayCalories - proteinCalories - lowCarbCalories) / 9);
        const mediumFat = Math.round((mediumDayCalories - proteinCalories - mediumCarbCalories) / 9);
        const highFat = Math.round((highDayCalories - proteinCalories - highCarbCalories) / 9);

        // Display results
        displayResults({
            high: {
                calories: highDayCalories,
                carbs: highCarbs,
                protein: Math.round(protein),
                fat: highFat
            },
            medium: {
                calories: mediumDayCalories,
                carbs: mediumCarbs,
                protein: Math.round(protein),
                fat: mediumFat
            },
            low: {
                calories: lowDayCalories,
                carbs: lowCarbs,
                protein: Math.round(protein),
                fat: lowFat
            }
        }, trainingDays);

        // Show results
        results.style.display = 'block';
        results.scrollIntoView({ behavior: 'smooth' });
    }

    function displayResults(macros, trainingDays) {
        // Display macros
        document.getElementById('highCalories').textContent = macros.high.calories;
        document.getElementById('highCarbs').textContent = macros.high.carbs + 'g';
        document.getElementById('highProtein').textContent = macros.high.protein + 'g';
        document.getElementById('highFat').textContent = macros.high.fat + 'g';

        document.getElementById('mediumCalories').textContent = macros.medium.calories;
        document.getElementById('mediumCarbs').textContent = macros.medium.carbs + 'g';
        document.getElementById('mediumProtein').textContent = macros.medium.protein + 'g';
        document.getElementById('mediumFat').textContent = macros.medium.fat + 'g';

        document.getElementById('lowCalories').textContent = macros.low.calories;
        document.getElementById('lowCarbs').textContent = macros.low.carbs + 'g';
        document.getElementById('lowProtein').textContent = macros.low.protein + 'g';
        document.getElementById('lowFat').textContent = macros.low.fat + 'g';

        // Generate weekly schedule
        generateWeeklySchedule(trainingDays);
    }

    function generateWeeklySchedule(trainingDays) {
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const schedule = [];

        // Create optimal schedule based on training days
        if (trainingDays === 3) {
            schedule = ['High', 'Low', 'High', 'Low', 'High', 'Low', 'Low'];
        } else if (trainingDays === 4) {
            schedule = ['High', 'Low', 'High', 'Medium', 'High', 'Low', 'High'];
        } else if (trainingDays === 5) {
            schedule = ['High', 'Medium', 'High', 'Low', 'High', 'High', 'Low'];
        } else if (trainingDays === 6) {
            schedule = ['High', 'High', 'Medium', 'High', 'High', 'Medium', 'Low'];
        } else if (trainingDays === 7) {
            schedule = ['High', 'High', 'Medium', 'High', 'High', 'High', 'Medium'];
        }

        const scheduleContainer = document.getElementById('weeklySchedule');
        scheduleContainer.innerHTML = '';

        days.forEach((day, index) => {
            const dayElement = document.createElement('div');
            dayElement.className = `schedule-day ${schedule[index].toLowerCase()}-day`;
            dayElement.innerHTML = `
                <div class="day-name">${day}</div>
                <div class="day-carb-type">${schedule[index]}-Carb</div>
            `;
            scheduleContainer.appendChild(dayElement);
        });
    }
});
</script>
{% endblock %}
